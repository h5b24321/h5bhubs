--[[
    QUANTUM.NZ UI - ULTRA SOURCE (FULL VERSION)
    Developed & Optimized by: CostyTR
    Security: Anti-CoreGui Crash / Safe Parenting
]]

local Quantum = {}
Quantum.__index = Quantum

--// Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Players = game:GetService("Players")

--// Global Theme
local Theme = {
    Main = Color3.fromRGB(10, 10, 10),
    Accent = Color3.fromRGB(0, 255, 120),
    Text = Color3.fromRGB(255, 255, 255),
    SubText = Color3.fromRGB(170, 170, 170),
    Outline = Color3.fromRGB(40, 40, 45),
    Transparency = 0.12
}

--// Helper Functions
local function Tween(obj, time, prop, style)
    local info = TweenInfo.new(time, style or Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    local t = TweenService:Create(obj, info, prop)
    t:Play()
    return t
end

--// CoreGui Hata Çözümü (Safe Parenting)
local function GetGuiParent()
    local success, parent = pcall(function()
        return (gethui and gethui()) or (CoreGui:FindFirstChild("RobloxGui")) or Players.LocalPlayer:WaitForChild("PlayerGui")
    end)
    return success and parent or Players.LocalPlayer:WaitForChild("PlayerGui")
end

--// Notification System
function Quantum:Notify(title, text, duration)
    local NotifyFrame = Instance.new("Frame", self.Screen)
    NotifyFrame.Size = UDim2.new(0, 260, 0, 75)
    NotifyFrame.Position = UDim2.new(1, 20, 1, -100)
    NotifyFrame.BackgroundColor3 = Theme.Main
    NotifyFrame.BorderSizePixel = 0
    Instance.new("UICorner", NotifyFrame).CornerRadius = UDim.new(0, 10)
    local Stroke = Instance.new("UIStroke", NotifyFrame)
    Stroke.Color = Theme.Accent; Stroke.Thickness = 1.8

    local T = Instance.new("TextLabel", NotifyFrame)
    T.Size = UDim2.new(1, -20, 0, 30); T.Position = UDim2.new(0, 10, 0, 5)
    T.Text = title .. " | Made by CostyTR"; T.TextColor3 = Theme.Accent; T.Font = Enum.Font.GothamBold; T.TextSize = 14; T.BackgroundTransparency = 1; T.TextXAlignment = Enum.TextXAlignment.Left

    local D = Instance.new("TextLabel", NotifyFrame)
    D.Size = UDim2.new(1, -20, 0, 35); D.Position = UDim2.new(0, 10, 0, 32)
    D.Text = text; D.TextColor3 = Theme.Text; D.Font = Enum.Font.Gotham; D.TextSize = 12; D.BackgroundTransparency = 1; D.TextXAlignment = Enum.TextXAlignment.Left; D.TextWrapped = true

    Tween(NotifyFrame, 0.6, {Position = UDim2.new(1, -280, 1, -100)}, Enum.EasingStyle.Back)
    task.delay(duration or 4, function()
        Tween(NotifyFrame, 0.5, {Position = UDim2.new(1, 20, 1, -100)})
        task.wait(0.5); NotifyFrame:Destroy()
    end)
end

function Quantum:CreateWindow(cfg)
    local self = setmetatable({}, Quantum)
    self.Title = cfg.Title or "CostyTR Hub"
    self.Keybind = cfg.Keybind or Enum.KeyCode.RightControl
    self.Toggled = true
    
    self.Screen = Instance.new("ScreenGui")
    self.Screen.Name = "QuantumNZ_Final"
    self.Screen.Parent = GetGuiParent()
    self.Screen.IgnoreGuiInset = true

    --// Intro: Quantum.nz (Zorunlu)
    local function StartIntro()
        local Blur = Instance.new("BlurEffect", Lighting)
        local Logo = Instance.new("TextLabel", self.Screen)
        Logo.Size = UDim2.new(1,0,1,0); Logo.Text = "Quantum.nz"; Logo.TextColor3 = Theme.Accent; Logo.Font = Enum.Font.GothamBold; Logo.TextSize = 85; Logo.BackgroundTransparency = 1; Logo.TextTransparency = 1
        
        Tween(Blur, 1, {Size = 25}); Tween(Logo, 1, {TextTransparency = 0})
        task.wait(2); Tween(Logo, 0.8, {TextTransparency = 1, TextSize = 120}); Tween(Blur, 1, {Size = 0})
        task.wait(0.8); Blur:Destroy(); Logo:Destroy()
    end

    --// Main Window
    self.Main = Instance.new("Frame", self.Screen)
    self.Main.Size = UDim2.new(0, 680, 0, 480)
    self.Main.Position = UDim2.new(0.5, -340, 0.5, -240)
    self.Main.BackgroundColor3 = Theme.Main
    self.Main.BackgroundTransparency = Theme.Transparency
    self.Main.ClipsDescendants = true
    self.Main.Visible = false
    Instance.new("UICorner", self.Main).CornerRadius = UDim.new(0, 14)
    local MStroke = Instance.new("UIStroke", self.Main)
    MStroke.Color = Theme.Outline; MStroke.Thickness = 1.2

    -- TopBar (Sürükleme)
    local TopBar = Instance.new("Frame", self.Main)
    TopBar.Size = UDim2.new(1, 0, 0, 50); TopBar.BackgroundTransparency = 1

    --// DRAG & RESIZE (Latex Style)
    local dragging, dragStart, startPos
    TopBar.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging=true; dragStart=i.Position; startPos=self.Main.Position end end)
    
    local resizing, resStart, resSize
    local Resizer = Instance.new("Frame", self.Main)
    Resizer.Size = UDim2.new(0, 30, 0, 30); Resizer.Position = UDim2.new(1, -30, 1, -30); Resizer.BackgroundTransparency = 1; Resizer.ZIndex = 100
    Resizer.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then resizing=true; resStart=i.Position; resSize=self.Main.Size end end)

    UserInputService.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = i.Position - dragStart
            self.Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        elseif resizing and i.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = i.Position - resStart
            self.Main.Size = UDim2.new(0, math.max(550, resSize.X.Offset + delta.X), 0, math.max(380, resSize.Y.Offset + delta.Y))
        end
    end)
    UserInputService.InputEnded:Connect(function() dragging=false; resizing=false end)

    -- MacOS Controls
    local function CreateMac(color, pos, func)
        local b = Instance.new("TextButton", TopBar)
        b.Size = UDim2.new(0, 14, 0, 14); b.Position = pos; b.BackgroundColor3 = color; b.Text = ""
        Instance.new("UICorner", b).CornerRadius = UDim.new(1, 0)
        b.MouseButton1Click:Connect(func)
    end
    CreateMac(Color3.fromRGB(255, 95, 87), UDim2.new(0, 18, 0.5, -7), function() self:Toggle() end)
    CreateMac(Color3.fromRGB(255, 189, 46), UDim2.new(0, 40, 0.5, -7), function() self:Notify("Sistem", "Minimize Modu Aktif!", 2) end)
    CreateMac(Color3.fromRGB(40, 200, 64), UDim2.new(0, 62, 0.5, -7), function() self.Main.Size = UDim2.new(0, 900, 0, 600) end)

    local Title = Instance.new("TextLabel", TopBar)
    Title.Size = UDim2.new(1, -150, 1, 0); Title.Position = UDim2.new(0, 95, 0, 0)
    Title.Text = "Quantum.nz | Made by CostyTR"; Title.TextColor3 = Theme.SubText; Title.Font = Enum.Font.GothamBold; Title.TextSize = 14; Title.BackgroundTransparency = 1; Title.TextXAlignment = Enum.TextXAlignment.Left

    -- SideBar & Pages
    local SideBar = Instance.new("ScrollingFrame", self.Main)
    SideBar.Size = UDim2.new(0, 170, 1, -110); SideBar.Position = UDim2.new(0, 15, 0, 65); SideBar.BackgroundTransparency = 1; SideBar.ScrollBarThickness = 0
    Instance.new("UIListLayout", SideBar).Padding = UDim.new(0, 6)

    local PageHold = Instance.new("Frame", self.Main)
    PageHold.Size = UDim2.new(1, -210, 1, -85); PageHold.Position = UDim2.new(0, 195, 0, 65); PageHold.BackgroundTransparency = 1

    local Footer = Instance.new("TextLabel", self.Main)
    Footer.Size = UDim2.new(1, -20, 0, 35); Footer.Position = UDim2.new(0, 10, 1, -40)
    Footer.Text = "Quantum Premium - Developed by CostyTR"; Footer.TextColor3 = Theme.Accent; Footer.Font = Enum.Font.GothamMedium; Footer.TextSize = 12; Footer.BackgroundTransparency = 1; Footer.TextXAlignment = Enum.TextXAlignment.Right

    --// Toggle Logic (Animated)
    function self:Toggle()
        self.Toggled = not self.Toggled
        if self.Toggled then
            self.Main.Visible = true
            Tween(self.Main, 0.5, {Size = UDim2.new(0, 680, 0, 480), BackgroundTransparency = Theme.Transparency}, Enum.EasingStyle.Back)
        else
            Tween(self.Main, 0.5, {Size = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1}, Enum.EasingStyle.Back)
            task.wait(0.5); self.Main.Visible = false
        end
    end
    UserInputService.InputBegan:Connect(function(i, p) if not p and i.KeyCode == self.Keybind then self:Toggle() end end)

    task.spawn(function() StartIntro(); self.Main.Visible = true; Tween(self.Main, 0.7, {Size = UDim2.new(0, 680, 0, 480)}, Enum.EasingStyle.Back) end)

    function self:CreateTab(name)
        local Tab = {}
        local TBtn = Instance.new("TextButton", SideBar)
        TBtn.Size = UDim2.new(1, 0, 0, 40); TBtn.BackgroundColor3 = Color3.fromRGB(28, 28, 32); TBtn.Text = name; TBtn.TextColor3 = Theme.SubText; TBtn.Font = Enum.Font.GothamBold; TBtn.TextSize = 13
        Instance.new("UICorner", TBtn).CornerRadius = UDim.new(0, 8)

        local Page = Instance.new("ScrollingFrame", PageHold)
        Page.Size = UDim2.new(1, 0, 1, 0); Page.Visible = false; Page.BackgroundTransparency = 1; Page.ScrollBarThickness = 2; Page.ScrollBarImageColor3 = Theme.Accent
        Instance.new("UIListLayout", Page).Padding = UDim.new(0, 10)

        TBtn.MouseButton1Click:Connect(function()
            for _, v in pairs(PageHold:GetChildren()) do v.Visible = false end
            Page.Visible = true
        end)
        if #SideBar:GetChildren() == 1 then Page.Visible = true end

        -- Element: Button
        function Tab:CreateButton(txt, cb)
            local b = Instance.new("TextButton", Page)
            b.Size = UDim2.new(1, -12, 0, 45); b.BackgroundColor3 = Color3.fromRGB(22, 22, 26); b.Text = txt .. " | CostyTR"; b.TextColor3 = Theme.Text; b.Font = Enum.Font.GothamMedium; b.TextSize = 14
            Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
            b.MouseButton1Click:Connect(cb)
        end

-- Element: Radio Knob (FIXED - CoreGui Safe)
function Tab:CreateKnob(text, min, max, def, cb)
    local KFrame = Instance.new("Frame", Page)
    KFrame.Size = UDim2.new(1, -12, 0, 100)
    KFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
    KFrame.BackgroundTransparency = 0.4
    Instance.new("UICorner", KFrame).CornerRadius = UDim.new(0, 10)

    local KT = Instance.new("TextLabel", KFrame)
    KT.Size = UDim2.new(0.6, 0, 1, 0)
    KT.Position = UDim2.new(0, 15, 0, 0)
    KT.Text = text
    KT.TextColor3 = Theme.Text
    KT.Font = Enum.Font.GothamBold
    KT.BackgroundTransparency = 1
    KT.TextXAlignment = Enum.TextXAlignment.Left

    local Outer = Instance.new("ImageButton", KFrame)
    Outer.Size = UDim2.new(0, 70, 0, 70)
    Outer.Position = UDim2.new(0.8, 0, 0.5, -35)
    Outer.Image = "rbxassetid://6031097063"
    Outer.BackgroundTransparency = 1
    Outer.ImageColor3 = Theme.Accent
    Outer.AutoButtonColor = false

    local ValLbl = Instance.new("TextLabel", Outer)
    ValLbl.Size = UDim2.new(1, 0, 1, 0)
    ValLbl.Text = tostring(def)
    ValLbl.TextColor3 = Theme.Text
    ValLbl.Font = Enum.Font.GothamBold
    ValLbl.BackgroundTransparency = 1
    ValLbl.TextSize = 11

    local dragging = false
    local GuiInset = game:GetService("GuiService"):GetGuiInset()

    local function UpdateFromMouse()
        local mousePos = UserInputService:GetMouseLocation() - Vector2.new(GuiInset.X, GuiInset.Y)
        local center = Outer.AbsolutePosition + (Outer.AbsoluteSize / 2)

        local angle = math.atan2(mousePos.Y - center.Y, mousePos.X - center.X)
        local deg = math.deg(angle) + 90
        deg = (deg + 360) % 360

        Outer.Rotation = deg

        local percent = math.clamp(deg / 360, 0, 1)
        local value = math.floor(min + (max - min) * percent)

        ValLbl.Text = tostring(value)
        cb(value)
    end

    Outer.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            UpdateFromMouse()
        end
    end)

    UserInputService.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            UpdateFromMouse()
        end
    end)

    UserInputService.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    return Tab
end

return self
end

return Quantum

